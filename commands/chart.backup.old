#!/bin/bash
# HALCON Chart Command - Generate Natal Chart
# Usage:
#   Structured: chart --date YYYY-MM-DD --time HH:MM:SS --lat LAT --lon LON [options]
#   Natural Language: chart mar 10 1990, kurnool india, 12:55 PM (manu)

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_DIR="$SCRIPT_DIR/../claude-sdk-microservice"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Show usage if no args
if [ $# -eq 0 ]; then
    echo -e "${CYAN}╔════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         HALCON NATAL CHART                 ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Generate a natal chart with planetary positions"
    echo ""
    echo -e "${GREEN}Natural Language Usage:${NC}"
    echo "  chart Month Day Year, City Country, Time AM/PM (Name)"
    echo ""
    echo "Examples:"
    echo "  chart mar 10 1990, kurnool india, 12:55 PM (manu)"
    echo "  chart june 21 1985, london uk, 9:15 AM"
    echo "  chart dec 25 2000, new york usa, 6:30 PM local time"
    echo ""
    echo -e "${GREEN}Structured Usage:${NC}"
    echo "  chart --date YYYY-MM-DD --time HH:MM:SS --lat LAT --lon LON [options]"
    echo ""
    echo "Required:"
    echo "  --date, -d DATE     Birth date (YYYY-MM-DD)"
    echo "  --time, -t TIME     Birth time (HH:MM:SS)"
    echo "  --lat LAT           Birth latitude"
    echo "  --lon LON           Birth longitude"
    echo ""
    echo "Optional:"
    echo "  --name NAME         Chart name"
    echo "  --city CITY         Birth city"
    echo "  --format FORMAT     Output format: simple, detailed, json"
    echo "  --houses SYSTEM     House system: placidus, equal, whole-sign"
    echo ""
    echo "Structured Examples:"
    echo "  chart --date 1990-01-15 --time 14:30:00 --lat 40.7128 --lon -74.0060"
    echo "  chart -d 1985-06-21 -t 09:15:00 --lat 51.5074 --lon -0.1278 --city London"
    echo ""
    exit 0
fi

# Detect if input is natural language, profile lookup, or structured
FIRST_ARG="$1"

# If first arg starts with -- or -, it's structured (flag-based)
if [[ "$FIRST_ARG" =~ ^-{1,2} ]]; then
    # Structured mode - use TypeScript CLI
    cd "$PROJECT_DIR"
    exec npx ts-node -r tsconfig-paths/register src/cli/chart.ts "$@"
# If first arg is a simple word (profile name) and optionally followed by flags
elif [[ "$FIRST_ARG" =~ ^[a-zA-Z0-9_-]+$ ]] && ([[ $# -eq 1 ]] || [[ "$2" =~ ^-{1,2} ]]); then
    # Profile lookup mode (with or without flags)
    cd "$PROJECT_DIR"
    exec npx ts-node -r tsconfig-paths/register src/cli/chart.ts "$@"
else
    # Natural language mode - parse with chart-nlu
    echo -e "${YELLOW}🔍 Natural language mode detected${NC}" >&2
    echo "" >&2

    # Call chart-nlu to parse the natural language input
    PARSED_ARGS=$("$PROJECT_DIR/chart-nlu" "$@")
    EXIT_CODE=$?

    if [ $EXIT_CODE -ne 0 ]; then
        echo -e "${RED}❌ Failed to parse natural language input${NC}" >&2
        exit 1
    fi

    echo "" >&2
    echo -e "${GREEN}📊 Generating chart...${NC}" >&2
    echo "" >&2

    # Forward parsed args to chart TypeScript CLI
    cd "$PROJECT_DIR"
    eval exec npx ts-node -r tsconfig-paths/register src/cli/chart.ts $PARSED_ARGS
fi